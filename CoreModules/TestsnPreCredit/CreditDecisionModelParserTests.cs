using Microsoft.VisualStudio.TestTools.UnitTesting;
using nPreCredit.Code;
using System.Linq;

namespace TestsnPreCredit
{
    [TestClass]
    public class CreditDecisionModelParserTests
    {
        [TestMethod]
        public void NewLoan()
        {
            var s = "{\"additionalLoanOffer\":{\"creditNr\":\"L10699\",\"amount\":1000.0,\"newAnnuityAmount\":195.0,\"newMarginInterestRatePercent\":14.0},\"recommendation\":{\"HasOffer\":false,\"OfferedAmount\":null,\"MaxOfferedAmount\":null,\"OfferedRepaymentTimeInMonths\":null,\"OfferedInterestRatePercent\":null,\"OfferedNotificationFeeAmount\":null,\"OfferedInitialFeeAmount\":null,\"OfferedAdditionalLoanCreditNr\":null,\"OfferedAdditionalLoanNewAnnuityAmount\":null,\"OfferedAdditionalLoanNewMarginInterestPercent\":null,\"WasRejectedByMinimumDemands\":true,\"Rejections\":[\"HistoricalLateLoans\",\"HistoricalLateNotifications\"],\"RejectionsDebugItems\":[\"HistoricalLateLoans: currentlyOverdueNrOfDays=[58], maxNrOfDaysBetweenDueDateAndPaymentEver=[66]\",\"HistoricalLateNotifications: currentlyOverdueNrOfDays=[58], maxNrOfDaysBetweenDueDateAndPaymentLastSixMonths=[66]\"],\"LeftToLiveOn\":null,\"LeftToLiveOnDebugItems\":null,\"Score\":null,\"ScoreDebugItems\":null,\"RiskGroup\":null,\"RiskGroupDebugItems\":null,\"Dbr\":null},\"application\":{\"nrOfApplicants\":1,\"applicant1\":{\"approvedSat\":\"true\",\"birthDate\":\"1970-07-03\",\"carOrBoatLoanAmount\":\"0\",\"creditCardAmount\":\"0\",\"customerId\":\"4812\",\"education\":\"education_yrkesskola\",\"employedSinceMonth\":\"2005-08\",\"employer\":\"ica\",\"employerPhone\":\"46546546\",\"employment\":\"employment_fastanstalld\",\"housing\":\"housing_hyresbostad\",\"housingCostPerMonthAmount\":\"250\",\"incomePerMonthAmount\":\"5000\",\"marriage\":\"marriage_gift\",\"mortgageLoanAmount\":\"10000\",\"studentLoanAmount\":\"0\",\"otherLoanAmount\":\"0\",\"nrOfChildren\":\"0\"},\"application\":{\"amount\":\"11000\",\"loansToSettleAmount\":\"0\",\"repaymentTimeInYears\":\"7\"}},\"otherApplications\":{\"applicant1\":[{\"ApplicationNr\":\"CA54921\",\"IsActive\":false,\"CreditCheckStatus\":\"Rejected\",\"CreditNr\":null,\"ApplicationDate\":\"2017-09-06T22:00:03.657684+00:00\",\"IsFinalDecisionMade\":false},{\"ApplicationNr\":\"CA59010\",\"IsActive\":false,\"CreditCheckStatus\":\"Rejected\",\"CreditNr\":null,\"ApplicationDate\":\"2017-09-20T11:19:27.6413669+00:00\",\"IsFinalDecisionMade\":false},{\"ApplicationNr\":\"CA64367\",\"IsActive\":false,\"CreditCheckStatus\":\"Rejected\",\"CreditNr\":null,\"ApplicationDate\":\"2017-10-11T13:12:16.2960597+00:00\",\"IsFinalDecisionMade\":false},{\"ApplicationNr\":\"CA64523\",\"IsActive\":false,\"CreditCheckStatus\":\"Rejected\",\"CreditNr\":null,\"ApplicationDate\":\"2017-10-11T18:07:03.908836+00:00\",\"IsFinalDecisionMade\":false},{\"ApplicationNr\":\"CA80650\",\"IsActive\":false,\"CreditCheckStatus\":\"Rejected\",\"CreditNr\":null,\"ApplicationDate\":\"2017-11-17T09:10:32.9923315+00:00\",\"IsFinalDecisionMade\":false}]},\"credits\":{\"applicant1\":[{\"CreditNr\":\"L10699\",\"CustomerIds\":[4812],\"NrOfApplicants\":1,\"ProviderName\":\"eone\",\"StartDate\":\"2017-01-13T12:58:40.0807731+00:00\",\"Status\":\"Normal\",\"CapitalBalance\":3848.26,\"MarginInterestRatePercent\":19.9,\"AnnuityAmount\":190.29,\"ReferenceInterestRatePercent\":-0.34,\"NotificationFeeAmount\":5.0,\"CurrentlyOverdueSinceDate\":\"2017-11-28T00:00:00\",\"MaxNrOfDaysBetweenDueDateAndPaymentLastSixMonths\":66,\"MaxNrOfDaysBetweenDueDateAndPaymentEver\":66,\"IsOrHasBeenOnDebtCollection\":false,\"NrOfClosedNotifications\":10,\"ApplicationNr\":\"CA15228\"}]}}";
            var m = CreditDecisionModelParser.ParseHistoricalCredits(s);
            Assert.AreEqual("L10699", m.Single().Value.Single().CreditNr);
            Assert.AreEqual(3848.26m, m.Single().Value.Single().CapitalBalance);
            Assert.AreEqual(19.9m, m.Single().Value.Single().MarginInterestRatePercent);
            Assert.AreEqual(190.29m, m.Single().Value.Single().AnnuityAmount);
            Assert.AreEqual(-0.34m, m.Single().Value.Single().ReferenceInterestRatePercent);
            Assert.AreEqual(5m, m.Single().Value.Single().NotificationFeeAmount);
            Assert.AreEqual(17.05m, CreditDecisionModelParser.ParseOfferEffectiveInterestRate(s, false));
        }

        [TestMethod]
        public void AdditionalLoan()
        {
            var s = "{\"offer\":{\"amount\":7000.0,\"repaymentTimeInMonths\":24,\"marginInterestRatePercent\":13.9,\"referenceInterestRatePercent\":-0.34,\"initialFeeAmount\":150.0,\"notificationFeeAmount\":5.0,\"annuityAmount\":341.81,\"effectiveInterestRatePercent\":18.64,\"totalPaidAmount\":8323.39,\"initialPaidToCustomerAmount\":7000.0},\"recommendation\":{\"HasOffer\":true,\"OfferedAmount\":7000.0,\"MaxOfferedAmount\":20000.0,\"OfferedRepaymentTimeInMonths\":24,\"OfferedInterestRatePercent\":13.90,\"OfferedNotificationFeeAmount\":5.0,\"OfferedInitialFeeAmount\":150.0,\"OfferedAdditionalLoanCreditNr\":null,\"OfferedAdditionalLoanNewAnnuityAmount\":null,\"OfferedAdditionalLoanNewMarginInterestPercent\":null,\"WasRejectedByMinimumDemands\":false,\"Rejections\":[],\"RejectionsDebugItems\":[],\"LeftToLiveOn\":2180.44,\"LeftToLiveOnDebugItems\":[\"incomePerMonth1: 3250.00\",\"housingCostPerMonth1: -250.00\",\"legalMinimunLivingCost1: -451.00\",\"monthlyCostOfNewLoan: -368.56\"],\"Score\":585,\"ScoreDebugItems\":[\"base(555): 555\",\"age(39): -22\",\"education(education_yrkesskola): 3\",\"marriage(marriage_gift): 6\",\"income(60000): 0\",\"mortgageLoan(10000): -17\",\"housing(housing_hyresbostad): 0\",\"amount(7000): -5\",\"creditCardAmount(0): -12\",\"otherLoans(0): -3\",\"addressAge(823): 2\",\"employedForMonths(149): 2\",\"bricRiskOfPaymentRemark(Small): 76\"],\"RiskGroup\":\"B\",\"RiskGroupDebugItems\":[\"Base riskclass=7\",\"Adjustment total: 0\",\"Adjustment positivePaymentHistory(<NotImplemented>): 0\",\"Adjustment twoApplicants(1): 0\",\"Adjustment negativeKalp(isTwoOrOneSingle=false;kalp=2180.44): 0\",\"Adjustment hasNegativeBusinessConnection(false): 0\",\"Adjustment dbr(0.0): 0\"],\"Dbr\":0.0},\"application\":{\"nrOfApplicants\":1,\"applicant1\":{\"approvedSat\":\"true\",\"birthDate\":\"1979-06-05\",\"carOrBoatLoanAmount\":\"0\",\"creditCardAmount\":\"0\",\"customerId\":\"51910\",\"education\":\"education_yrkesskola\",\"employedSinceMonth\":\"2005-08\",\"employer\":\"ica\",\"employerPhone\":\"46546546\",\"employment\":\"employment_fastanstalld\",\"housing\":\"housing_hyresbostad\",\"housingCostPerMonthAmount\":\"250\",\"incomePerMonthAmount\":\"5000\",\"marriage\":\"marriage_gift\",\"mortgageLoanAmount\":\"10000\",\"studentLoanAmount\":\"0\",\"otherLoanAmount\":\"0\",\"nrOfChildren\":\"0\"},\"application\":{\"amount\":\"7000\",\"loansToSettleAmount\":\"0\",\"repaymentTimeInYears\":\"2\"}},\"otherApplications\":{\"applicant1\":[]},\"credits\":{\"applicant1\":[]},\"creditReportsUsed\":[{\"CreditReportId\":7,\"CustomerId\":51910,\"ApplicantNr\":1,\"ProviderName\":\"TestOnlyFi\"},{\"CreditReportId\":8,\"CustomerId\":51910,\"ApplicantNr\":1,\"ProviderName\":\"SatFi\"}]}";
            Assert.AreEqual(18.64m, CreditDecisionModelParser.ParseOfferEffectiveInterestRate(s, false));
            Assert.AreEqual(18.64m, CreditDecisionModelParser.ParseOfferEffectiveInterestRate(s.Replace("effectiveInterestRatePercent", "kitten"), false));
        }
    }
}