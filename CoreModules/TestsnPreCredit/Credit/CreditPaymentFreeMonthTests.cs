using Microsoft.VisualStudio.TestTools.UnitTesting;
using nCredit;
using nCredit.DbModel.DomainModel;
using Newtonsoft.Json;
using NTech.Banking.LoanModel;
using NTech.Core;
using System;
using System.Linq;
using System.Text;

namespace TestsnPreCredit.Credit
{
    [TestClass]
    public class CreditPaymentFreeMonthTests
    {
        private HistoricalCreditModel GetExampleWithPaymentAfterPaymentFreeMonth()
        {
            /*
             * 2017-12-14 was payment free
             * 2018-10-01 a payment came in
             * 2018-10-11 the user noticed that they can makey january payment free even though december was payment free (should not be possible)
             *
             * The reason was that the logic incorrectly looked the rows before and after in the amortization plan instead of only looking at notifications and payment free month type events
             */
            const string ExampleModel1 = @"eyJDcmVkaXROciI6IkwxMTczOCIsIlN0YXR1cyI6Ik5vcm1hbCIsIkNyZWF0ZWRCeUV2ZW50Ijp7IklkIjo3MzkxLCJFdmVudFR5cGUiOiJOZXdDcmVkaXQiLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTA1LTIzVDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQUNBVFU9In0sIkFubnVpdHlBbW91bnQiOjI5Ni43NCwiUmVmZXJlbmNlSW50ZXJlc3RSYXRlUGVyY2VudCI6LTAuMzQsIk5vdGlmaWNhdGlvbkZlZSI6NS4wMCwiTWFyZ2luSW50ZXJlc3RSYXRlUGVyY2VudCI6MTQuOTAsIlRyYW5zYWN0aW9ucyI6W3siSWQiOjM0MDkwLCJBY2NvdW50Q29kZSI6IkludGVyZXN0RGVidCIsIkFtb3VudCI6Mjk3LjIwLCJJc1dyaXRlT2ZmIjpmYWxzZSwiSXNJbmNvbWluZ1BheW1lbnQiOmZhbHNlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjo5MDIzLCJFdmVudFR5cGUiOiJOZXdOb3RpZmljYXRpb24iLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTA2LTE0VDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQUNZeU09In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTA2LTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjM5MzM5LCJBY2NvdW50Q29kZSI6IkludGVyZXN0RGVidCIsIkFtb3VudCI6LTI5Ny4yMCwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50Ijp0cnVlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoxMDI4NiwiRXZlbnRUeXBlIjoiTmV3SW5jb21pbmdQYXltZW50RmlsZSIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMDctMDdUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBQ3k5az0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6IjIwMTctMDYtMjhUMDA6MDA6MDAiLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6NDMyNzcsIkFjY291bnRDb2RlIjoiSW50ZXJlc3REZWJ0IiwiQW1vdW50IjoyNDAuOTcsIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6ZmFsc2UsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjExNDY3LCJFdmVudFR5cGUiOiJOZXdOb3RpZmljYXRpb24iLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTA3LTE0VDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQUM5a289In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTA3LTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjQ4Nzc3LCJBY2NvdW50Q29kZSI6IkludGVyZXN0RGVidCIsIkFtb3VudCI6LTI0MC45NywiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50Ijp0cnVlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoxMjg0NSwiRXZlbnRUeXBlIjoiTmV3SW5jb21pbmdQYXltZW50RmlsZSIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMDgtMDhUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBRFhYQT0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6IjIwMTctMDctMjhUMDA6MDA6MDAiLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6NTI2MDIsIkFjY291bnRDb2RlIjoiSW50ZXJlc3REZWJ0IiwiQW1vdW50IjoyNDguNTQsIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6ZmFsc2UsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjEzOTE4LCJFdmVudFR5cGUiOiJOZXdOb3RpZmljYXRpb24iLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTA4LTE0VDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQURpNHM9In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTA4LTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjU4NTQ5LCJBY2NvdW50Q29kZSI6IkludGVyZXN0RGVidCIsIkFtb3VudCI6LTI0OC41NCwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50Ijp0cnVlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoxNTQyOCwiRXZlbnRUeXBlIjoiTmV3SW5jb21pbmdQYXltZW50RmlsZSIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMDktMDdUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBRCtWTT0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6IjIwMTctMDgtMjhUMDA6MDA6MDAiLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6NjE4NDcsIkFjY291bnRDb2RlIjoiSW50ZXJlc3REZWJ0IiwiQW1vdW50IjoyNDcuODksIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6ZmFsc2UsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjE2NDE5LCJFdmVudFR5cGUiOiJOZXdOb3RpZmljYXRpb24iLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTA5LTE0VDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQUVIR2c9In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTA5LTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjY2MzkzLCJBY2NvdW50Q29kZSI6IkludGVyZXN0RGVidCIsIkFtb3VudCI6LTI0Ny44OSwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50Ijp0cnVlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoxNzg2NywiRXZlbnRUeXBlIjoiTmV3SW5jb21pbmdQYXltZW50RmlsZSIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMTAtMDNUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBRWNlOD0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6IjIwMTctMDktMjhUMDA6MDA6MDAiLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6NzE5MzAsIkFjY291bnRDb2RlIjoiSW50ZXJlc3REZWJ0IiwiQW1vdW50IjoyMzkuMjIsIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6ZmFsc2UsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjE5MDc5LCJFdmVudFR5cGUiOiJOZXdOb3RpZmljYXRpb24iLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTEwLTE0VDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQUV0TFU9In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTEwLTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjc2MDYyLCJBY2NvdW50Q29kZSI6IkludGVyZXN0RGVidCIsIkFtb3VudCI6LTIzOS4yMiwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50Ijp0cnVlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoyMDU5MCwiRXZlbnRUeXBlIjoiTmV3SW5jb21pbmdQYXltZW50RmlsZSIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMTAtMzFUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBRkRQdz0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6IjIwMTctMTAtMjhUMDA6MDA6MDAiLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6ODA5MjUsIkFjY291bnRDb2RlIjoiSW50ZXJlc3REZWJ0IiwiQW1vdW50IjoyNDYuNDUsIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6ZmFsc2UsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjIxNzM4LCJFdmVudFR5cGUiOiJOZXdOb3RpZmljYXRpb24iLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTExLTE0VDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQUZUK3c9In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTExLTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjgyOTIzLCJBY2NvdW50Q29kZSI6IkludGVyZXN0RGVidCIsIkFtb3VudCI6LTI0Ni40NSwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50Ijp0cnVlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoyMjczMCwiRXZlbnRUeXBlIjoiTmV3SW5jb21pbmdQYXltZW50RmlsZSIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMTEtMTZUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBRmNpUT0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6IjIwMTctMTEtMjhUMDA6MDA6MDAiLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6MzQwOTEsIkFjY291bnRDb2RlIjoiTm90aWZpY2F0aW9uRmVlRGVidCIsIkFtb3VudCI6NS4wMCwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50IjpmYWxzZSwiQnVzaW5lc3NFdmVudCI6eyJJZCI6OTAyMywiRXZlbnRUeXBlIjoiTmV3Tm90aWZpY2F0aW9uIiwiVHJhbnNhY3Rpb25EYXRlIjoiMjAxNy0wNi0xNFQwMDowMDowMCIsIlRpbWVzdGFtcCI6IkFBQUFBQUFDWXlNPSJ9LCJDcmVkaXROb3RpZmljYXRpb25EdWVEYXRlIjoiMjAxNy0wNi0yOFQwMDowMDowMCIsIlBheW1lbnRGcmVlTW9udGhEdWVEYXRlIjpudWxsfSx7IklkIjozOTM0MCwiQWNjb3VudENvZGUiOiJOb3RpZmljYXRpb25GZWVEZWJ0IiwiQW1vdW50IjotNS4wMCwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50Ijp0cnVlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoxMDI4NiwiRXZlbnRUeXBlIjoiTmV3SW5jb21pbmdQYXltZW50RmlsZSIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMDctMDdUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBQ3k5az0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6IjIwMTctMDYtMjhUMDA6MDA6MDAiLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6NDMyNzgsIkFjY291bnRDb2RlIjoiTm90aWZpY2F0aW9uRmVlRGVidCIsIkFtb3VudCI6NS4wMCwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50IjpmYWxzZSwiQnVzaW5lc3NFdmVudCI6eyJJZCI6MTE0NjcsIkV2ZW50VHlwZSI6Ik5ld05vdGlmaWNhdGlvbiIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMDctMTRUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBQzlrbz0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6IjIwMTctMDctMjhUMDA6MDA6MDAiLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6NDg3NzgsIkFjY291bnRDb2RlIjoiTm90aWZpY2F0aW9uRmVlRGVidCIsIkFtb3VudCI6LTUuMDAsIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6dHJ1ZSwiQnVzaW5lc3NFdmVudCI6eyJJZCI6MTI4NDUsIkV2ZW50VHlwZSI6Ik5ld0luY29taW5nUGF5bWVudEZpbGUiLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTA4LTA4VDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQURYWEE9In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTA3LTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjUyNjAzLCJBY2NvdW50Q29kZSI6Ik5vdGlmaWNhdGlvbkZlZURlYnQiLCJBbW91bnQiOjUuMDAsIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6ZmFsc2UsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjEzOTE4LCJFdmVudFR5cGUiOiJOZXdOb3RpZmljYXRpb24iLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTA4LTE0VDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQURpNHM9In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTA4LTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjU4NTUwLCJBY2NvdW50Q29kZSI6Ik5vdGlmaWNhdGlvbkZlZURlYnQiLCJBbW91bnQiOi01LjAwLCJJc1dyaXRlT2ZmIjpmYWxzZSwiSXNJbmNvbWluZ1BheW1lbnQiOnRydWUsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjE1NDI4LCJFdmVudFR5cGUiOiJOZXdJbmNvbWluZ1BheW1lbnRGaWxlIiwiVHJhbnNhY3Rpb25EYXRlIjoiMjAxNy0wOS0wN1QwMDowMDowMCIsIlRpbWVzdGFtcCI6IkFBQUFBQUFEK1ZNPSJ9LCJDcmVkaXROb3RpZmljYXRpb25EdWVEYXRlIjoiMjAxNy0wOC0yOFQwMDowMDowMCIsIlBheW1lbnRGcmVlTW9udGhEdWVEYXRlIjpudWxsfSx7IklkIjo2MTg0OCwiQWNjb3VudENvZGUiOiJOb3RpZmljYXRpb25GZWVEZWJ0IiwiQW1vdW50Ijo1LjAwLCJJc1dyaXRlT2ZmIjpmYWxzZSwiSXNJbmNvbWluZ1BheW1lbnQiOmZhbHNlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoxNjQxOSwiRXZlbnRUeXBlIjoiTmV3Tm90aWZpY2F0aW9uIiwiVHJhbnNhY3Rpb25EYXRlIjoiMjAxNy0wOS0xNFQwMDowMDowMCIsIlRpbWVzdGFtcCI6IkFBQUFBQUFFSEdnPSJ9LCJDcmVkaXROb3RpZmljYXRpb25EdWVEYXRlIjoiMjAxNy0wOS0yOFQwMDowMDowMCIsIlBheW1lbnRGcmVlTW9udGhEdWVEYXRlIjpudWxsfSx7IklkIjo2NjM5NCwiQWNjb3VudENvZGUiOiJOb3RpZmljYXRpb25GZWVEZWJ0IiwiQW1vdW50IjotNS4wMCwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50Ijp0cnVlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoxNzg2NywiRXZlbnRUeXBlIjoiTmV3SW5jb21pbmdQYXltZW50RmlsZSIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMTAtMDNUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBRWNlOD0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6IjIwMTctMDktMjhUMDA6MDA6MDAiLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6NzE5MzEsIkFjY291bnRDb2RlIjoiTm90aWZpY2F0aW9uRmVlRGVidCIsIkFtb3VudCI6NS4wMCwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50IjpmYWxzZSwiQnVzaW5lc3NFdmVudCI6eyJJZCI6MTkwNzksIkV2ZW50VHlwZSI6Ik5ld05vdGlmaWNhdGlvbiIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMTAtMTRUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBRXRMVT0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6IjIwMTctMTAtMjhUMDA6MDA6MDAiLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6NzYwNjMsIkFjY291bnRDb2RlIjoiTm90aWZpY2F0aW9uRmVlRGVidCIsIkFtb3VudCI6LTUuMDAsIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6dHJ1ZSwiQnVzaW5lc3NFdmVudCI6eyJJZCI6MjA1OTAsIkV2ZW50VHlwZSI6Ik5ld0luY29taW5nUGF5bWVudEZpbGUiLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTEwLTMxVDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQUZEUHc9In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTEwLTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjgwOTI2LCJBY2NvdW50Q29kZSI6Ik5vdGlmaWNhdGlvbkZlZURlYnQiLCJBbW91bnQiOjUuMDAsIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6ZmFsc2UsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjIxNzM4LCJFdmVudFR5cGUiOiJOZXdOb3RpZmljYXRpb24iLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTExLTE0VDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQUZUK3c9In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTExLTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjgyOTI0LCJBY2NvdW50Q29kZSI6Ik5vdGlmaWNhdGlvbkZlZURlYnQiLCJBbW91bnQiOi01LjAwLCJJc1dyaXRlT2ZmIjpmYWxzZSwiSXNJbmNvbWluZ1BheW1lbnQiOnRydWUsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjIyNzMwLCJFdmVudFR5cGUiOiJOZXdJbmNvbWluZ1BheW1lbnRGaWxlIiwiVHJhbnNhY3Rpb25EYXRlIjoiMjAxNy0xMS0xNlQwMDowMDowMCIsIlRpbWVzdGFtcCI6IkFBQUFBQUFGY2lRPSJ9LCJDcmVkaXROb3RpZmljYXRpb25EdWVEYXRlIjoiMjAxNy0xMS0yOFQwMDowMDowMCIsIlBheW1lbnRGcmVlTW9udGhEdWVEYXRlIjpudWxsfSx7IklkIjoyNzIyOCwiQWNjb3VudENvZGUiOiJOb3ROb3RpZmllZENhcGl0YWwiLCJBbW91bnQiOjIwMDAwLjAwLCJJc1dyaXRlT2ZmIjpmYWxzZSwiSXNJbmNvbWluZ1BheW1lbnQiOmZhbHNlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjo3MzkxLCJFdmVudFR5cGUiOiJOZXdDcmVkaXQiLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTA1LTIzVDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQUNBVFU9In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOm51bGwsIlBheW1lbnRGcmVlTW9udGhEdWVEYXRlIjpudWxsfSx7IklkIjoyNzIzMCwiQWNjb3VudENvZGUiOiJOb3ROb3RpZmllZENhcGl0YWwiLCJBbW91bnQiOjE1MC4wMCwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50IjpmYWxzZSwiQnVzaW5lc3NFdmVudCI6eyJJZCI6NzM5MiwiRXZlbnRUeXBlIjoiQ2FwaXRhbGl6ZWRJbml0aWFsRmVlIiwiVHJhbnNhY3Rpb25EYXRlIjoiMjAxNy0wNS0yM1QwMDowMDowMCIsIlRpbWVzdGFtcCI6IkFBQUFBQUFDQVRZPSJ9LCJDcmVkaXROb3RpZmljYXRpb25EdWVEYXRlIjpudWxsLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6NDMyNzYsIkFjY291bnRDb2RlIjoiTm90Tm90aWZpZWRDYXBpdGFsIiwiQW1vdW50IjotNTUuNzcsIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6ZmFsc2UsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjExNDY3LCJFdmVudFR5cGUiOiJOZXdOb3RpZmljYXRpb24iLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTA3LTE0VDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQUM5a289In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTA3LTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjUyNjAxLCJBY2NvdW50Q29kZSI6Ik5vdE5vdGlmaWVkQ2FwaXRhbCIsIkFtb3VudCI6LTQ4LjIwLCJJc1dyaXRlT2ZmIjpmYWxzZSwiSXNJbmNvbWluZ1BheW1lbnQiOmZhbHNlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoxMzkxOCwiRXZlbnRUeXBlIjoiTmV3Tm90aWZpY2F0aW9uIiwiVHJhbnNhY3Rpb25EYXRlIjoiMjAxNy0wOC0xNFQwMDowMDowMCIsIlRpbWVzdGFtcCI6IkFBQUFBQUFEaTRzPSJ9LCJDcmVkaXROb3RpZmljYXRpb25EdWVEYXRlIjoiMjAxNy0wOC0yOFQwMDowMDowMCIsIlBheW1lbnRGcmVlTW9udGhEdWVEYXRlIjpudWxsfSx7IklkIjo2MTg0NiwiQWNjb3VudENvZGUiOiJOb3ROb3RpZmllZENhcGl0YWwiLCJBbW91bnQiOi00OC44NSwiSXNXcml0ZU9mZiI6ZmFsc2UsIklzSW5jb21pbmdQYXltZW50IjpmYWxzZSwiQnVzaW5lc3NFdmVudCI6eyJJZCI6MTY0MTksIkV2ZW50VHlwZSI6Ik5ld05vdGlmaWNhdGlvbiIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMDktMTRUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBRUhHZz0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6IjIwMTctMDktMjhUMDA6MDA6MDAiLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6NzE5MjksIkFjY291bnRDb2RlIjoiTm90Tm90aWZpZWRDYXBpdGFsIiwiQW1vdW50IjotNTcuNTIsIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6ZmFsc2UsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjE5MDc5LCJFdmVudFR5cGUiOiJOZXdOb3RpZmljYXRpb24iLCJUcmFuc2FjdGlvbkRhdGUiOiIyMDE3LTEwLTE0VDAwOjAwOjAwIiwiVGltZXN0YW1wIjoiQUFBQUFBQUV0TFU9In0sIkNyZWRpdE5vdGlmaWNhdGlvbkR1ZURhdGUiOiIyMDE3LTEwLTI4VDAwOjAwOjAwIiwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjgwOTI0LCJBY2NvdW50Q29kZSI6Ik5vdE5vdGlmaWVkQ2FwaXRhbCIsIkFtb3VudCI6LTUwLjI5LCJJc1dyaXRlT2ZmIjpmYWxzZSwiSXNJbmNvbWluZ1BheW1lbnQiOmZhbHNlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoyMTczOCwiRXZlbnRUeXBlIjoiTmV3Tm90aWZpY2F0aW9uIiwiVHJhbnNhY3Rpb25EYXRlIjoiMjAxNy0xMS0xNFQwMDowMDowMCIsIlRpbWVzdGFtcCI6IkFBQUFBQUFGVCt3PSJ9LCJDcmVkaXROb3RpZmljYXRpb25EdWVEYXRlIjoiMjAxNy0xMS0yOFQwMDowMDowMCIsIlBheW1lbnRGcmVlTW9udGhEdWVEYXRlIjpudWxsfSx7IklkIjo4NjAyMywiQWNjb3VudENvZGUiOiJOb3ROb3RpZmllZENhcGl0YWwiLCJBbW91bnQiOi0zMDEuNzQsIklzV3JpdGVPZmYiOmZhbHNlLCJJc0luY29taW5nUGF5bWVudCI6ZmFsc2UsIkJ1c2luZXNzRXZlbnQiOnsiSWQiOjIzMzkzLCJFdmVudFR5cGUiOiJOZXdJbmNvbWluZ1BheW1lbnRGaWxlIiwiVHJhbnNhY3Rpb25EYXRlIjoiMjAxNy0xMi0wNFQwMDowMDowMCIsIlRpbWVzdGFtcCI6IkFBQUFBQUFGdzhVPSJ9LCJDcmVkaXROb3RpZmljYXRpb25EdWVEYXRlIjpudWxsLCJQYXltZW50RnJlZU1vbnRoRHVlRGF0ZSI6bnVsbH0seyJJZCI6ODc5NjksIkFjY291bnRDb2RlIjoiTm90Tm90aWZpZWRDYXBpdGFsIiwiQW1vdW50IjotMzAxLjc0LCJJc1dyaXRlT2ZmIjpmYWxzZSwiSXNJbmNvbWluZ1BheW1lbnQiOmZhbHNlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoyMzY2MCwiRXZlbnRUeXBlIjoiTmV3SW5jb21pbmdQYXltZW50RmlsZSIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMTItMTJUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBRjZFaz0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6bnVsbCwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9LHsiSWQiOjkwNjE2LCJBY2NvdW50Q29kZSI6Ik5vdE5vdGlmaWVkQ2FwaXRhbCIsIkFtb3VudCI6MjM3LjgwLCJJc1dyaXRlT2ZmIjpmYWxzZSwiSXNJbmNvbWluZ1BheW1lbnQiOmZhbHNlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoyNDQ4OCwiRXZlbnRUeXBlIjoiUGF5bWVudEZyZWVNb250aCIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTctMTItMTRUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBR0E0az0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6bnVsbCwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOiIyMDE3LTEyLTI4VDAwOjAwOjAwIn0seyJJZCI6OTc0ODUsIkFjY291bnRDb2RlIjoiTm90Tm90aWZpZWRDYXBpdGFsIiwiQW1vdW50IjotMzAxLjc0LCJJc1dyaXRlT2ZmIjpmYWxzZSwiSXNJbmNvbWluZ1BheW1lbnQiOmZhbHNlLCJCdXNpbmVzc0V2ZW50Ijp7IklkIjoyNjM2OCwiRXZlbnRUeXBlIjoiTmV3SW5jb21pbmdQYXltZW50RmlsZSIsIlRyYW5zYWN0aW9uRGF0ZSI6IjIwMTgtMDEtMTBUMDA6MDA6MDAiLCJUaW1lc3RhbXAiOiJBQUFBQUFBR2d6ND0ifSwiQ3JlZGl0Tm90aWZpY2F0aW9uRHVlRGF0ZSI6bnVsbCwiUGF5bWVudEZyZWVNb250aER1ZURhdGUiOm51bGx9XSwiUGVuZGluZ0Z1dHVyZVBheW1lbnRGcmVlTW9udGhzIjpbXSwiTnJPZlBhaWROb3RpZmljYXRpb25zIjo2fQ==";
            var annuityAmount = JsonConvert.DeserializeAnonymousType(Encoding.UTF8.GetString(Convert.FromBase64String(ExampleModel1)), new { AnnuityAmount = (decimal?)null });
            var m = JsonConvert.DeserializeObject<HistoricalCreditModel>(Encoding.UTF8.GetString(Convert.FromBase64String(ExampleModel1)));
            m.AmortizationModel = CreditAmortizationModel.CreateAnnuity(annuityAmount.AnnuityAmount.Value, null);
            return m;
        }

        private NotificationProcessSettings GetProcessSettings()
        {
            return new NotificationProcessSettings
            {
                NotificationNotificationDay = 14,
                NotificationDueDay = 28,
                PaymentFreeMonthMinNrOfPaidNotifications = 3,
                PaymentFreeMonthExcludeNotificationFee = false,
                PaymentFreeMonthMaxNrPerYear = 2,
                ReminderFeeAmount = 5,
                ReminderMinDaysBetween = 7,
                SkipReminderLimitAmount = 10,
                NotificationOverDueGraceDays = 5,
                MaxNrOfReminders = 2
            };
        }

        [TestMethod]
        public void PaymentFreeMonth_ShouldNotAllowTwoMonthsInARowEvenWithPaymentBetween()
        {
            var model = GetExampleWithPaymentAfterPaymentFreeMonth();
            AmortizationPlan p;
            string failedMessage;
            const int AnyBigNumber = 100;

            var clock = new StrictMock<ICoreClock>();
            clock.Setup(x => x.Today).Returns(model.CreatedByEvent.TransactionDate);

            Assert.IsTrue(FixedDueDayAmortizationPlanCalculator.TryGetAmortizationPlan(model, GetProcessSettings(), out p, out failedMessage, clock.Object, _ => 365.25m), failedMessage);

            var f = p.GetPossibleFuturePaymentFreeMonths(AnyBigNumber, GetProcessSettings());
            var januaryNotification = f.Single(x => x.Item.EventTypeCode == "NewNotification" && x.Item.EventTransactionDate == new DateTime(2018, 1, 14));

            Assert.AreEqual(januaryNotification.IsPossible, false);
        }
    }
}